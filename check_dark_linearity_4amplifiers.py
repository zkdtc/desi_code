from astropy.io import fits
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import os
from os import listdir
import pdb
from matplotlib.backends.backend_pdf import PdfPages
from scipy.signal import butter, lfilter, freqz
from scipy.signal import savgol_filter
import copy

preproc_dir='/global/project/projectdirs/desi/users/zhangkai/redux_nodark/'

########## Long darks taken on 20200608-0609 ############

night_arr0=['20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200608','20200608','20200608','20200608','20200608']
expid_arr0=['00056872','00056880','00056881','00056882','00056883','00056884','00056885','00056886','00056887','00056888','00056889','00056890','00056891','00056892','00056893','00056894','00056895','00056896','00056897','00056898','00056899','00056900','00056901','00056902','00056903','00056904','00056905','00056906','00056907','00056908','00056909','00056910','00056911','00056868','00056848','00056828','00056664','00056644','00056624','00056617'] # 200s, 1200s

night_arr0=['20200607','20200607','20200607','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609']
expid_arr0=['00056612','00056613','00056616','00056617','00056618','00056624','00056625','00056626','00056627','00056628','00056634','00056635','00056636','00056637','00056638','00056644','00056645','00056646','00056647','00056648','00056654','00056655','00056656','00056657','00056658','00056664','00056665','00056666','00056667','00056668','00056818','00056819','00056820','00056821','00056822','00056828','00056829','00056830','00056831','00056832','00056838','00056839','00056840','00056841','00056842','00056848','00056849','00056850','00056851','00056852','00056858','00056859','00056860','00056861','00056862','00056868','00056869','00056870','00056871','00056872','00056873','00056874','00056875','00056876','00056877','00056878','00056879','00056880','00056881','00056882','00056883','00056884','00056885','00056886','00056887','00056888','00056889','00056890','00056891','00056892','00056893','00056894','00056895','00056896','00056897','00056898','00056899','00056900','00056901','00056902','00056903','00056904','00056905','00056906','00056907','00056908','00056909','00056910','00056911','00056912','00056913','00056916','00056917','00056918','00056919','00056920','00056921','00056922','00056923','00056924','00056925','00056926','00056927','00056928','00056929','00056930','00056931','00056932','00056938','00056939','00056940','00056941','00056942','00056943','00056944','00056945','00056946','00056947','00056948','00056949','00056950','00056951','00056952','00056953','00056954','00056955','00056956','00056957','00056958','00056959','00056960','00056961','00056962','00056963','00056964','00056965','00056966','00056967','00056973','00056974','00056975','00056976','00056977','00056978','00056979','00056980','00056981','00056982','00056983','00056984','00056985','00056986','00056987','00056988','00056989','00056990']


night_arr=['20200607','20200607','20200607','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200608','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609','20200609']
expid_arr=['00056612','00056613','00056616','00056617','00056618','00056624','00056625','00056626','00056627','00056628','00056634','00056635','00056636','00056637','00056638','00056644','00056645','00056646','00056647','00056648','00056654','00056655','00056656','00056657','00056658','00056664','00056665','00056666','00056667','00056668','00056818','00056819','00056820','00056821','00056822','00056828','00056829','00056830','00056831','00056832','00056838','00056839','00056840','00056841','00056842','00056848','00056849','00056850','00056851','00056852','00056858','00056859','00056860','00056861','00056862','00056868','00056869','00056870','00056871','00056872','00056873','00056874','00056875','00056876','00056877','00056878','00056879','00056880','00056881','00056882','00056883','00056884','00056885','00056886','00056887','00056888','00056889','00056890','00056891','00056892','00056893','00056894','00056895','00056896','00056897','00056898','00056899','00056900','00056901','00056902','00056903','00056904','00056905','00056906','00056907','00056908','00056909','00056910','00056911','00056912','00056913','00056916','00056917','00056918','00056919','00056920','00056921','00056922','00056923','00056924','00056925','00056926','00056927','00056928','00056929','00056930','00056931','00056932','00056938','00056939','00056940','00056941','00056942','00056943','00056944','00056945','00056946','00056947','00056948','00056949','00056950','00056951','00056952','00056953','00056954','00056955','00056956','00056957','00056958','00056959','00056960','00056961','00056962','00056963','00056964','00056965','00056966','00056967','00056973','00056974','00056975','00056976','00056977','00056978','00056979','00056980','00056981','00056982','00056983','00056984','00056985','00056986','00056987','00056988','00056989','00056990']

################ Data Taken on 20200728-20200730 ######################

night_arr=['20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200728','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200729','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730','20200730']

expid_arr=['00060519','00060520','00060521','00060522','00060524','00060525','00060526','00060527','00060529','00060530','00060531','00060532','00060534','00060535','00060536','00060537','00060538','00060544','00060545','00060546','00060547','00060549','00060550','00060551','00060552','00060554','00060555','00060556','00060557','00060559','00060560','00060561','00060562','00060563','00060569','00060570','00060572','00060573','00060575','00060576','00060578','00060579','00060581','00060588','00060589','00060590','00060591','00060593','00060594','00060595','00060596','00060598','00060599','00060600','00060601','00060603','00060604','00060605','00060606','00060607','00060613','00060614','00060615','00060616','00060618','00060619','00060620','00060621','00060623','00060624','00060625','00060626','00060628','00060629','00060630','00060631','00060632','00060683','00060684','00060685','00060686','00060688','00060689','00060690','00060691','00060693','00060694','00060695','00060696','00060698','00060699','00060700','00060701','00060702','00060708','00060709','00060710','00060711','00060713','00060714','00060715','00060716','00060718','00060719','00060720','00060721','00060723','00060724','00060725','00060726','00060727','00060733','00060734','00060736','00060737','00060739','00060740','00060742','00060743','00060745','00060752','00060753','00060754','00060755','00060757','00060758','00060759','00060760','00060762','00060763','00060764','00060765','00060767','00060768','00060769','00060770','00060771','00060777','00060778','00060780','00060781','00060783','00060784','00060786','00060787','00060789']



sp_arr=['0', '1','2','3','4','5','6','7','8','9']
sm_arr=['4','10','5','6','1','9','7','8','2','3']
cam_arr=['b']#,'r','z']

### Regions to select ####
appendix='edge'
x1=0 #-50
x2=50 #-1
y1=1000
y2=1500

x3=0
x4=50
y3=2500
y4=3000

x5=-50
x6=-1
y5=1000
y6=1500

x7=-50
x8=-1
y7=2500
y8=3000
"""
# Central Part
appendix='central'
x1=1000
x2=1050
y1=1000
y2=1500

x3=1000
x4=1050
y3=2500
y4=3000

x5=3000
x6=3050
y5=1000
y6=1500

x7=3000
x8=3050
y7=2500
y8=3000
"""
#camera='b0'
n_expid=len(expid_arr)
n_expid0=len(expid_arr0)

with PdfPages('check_dark_linearity_20200728_4amp_'+appendix+'.pdf') as pdf:
    for cam in cam_arr:
        plt.figure(figsize=(12,10))
        font = {'family' : 'normal',
              'size'   : 12} # normally 16
        plt.rc('font', **font)
        index=1
        for i in range(len(sp_arr)):
            sp=sp_arr[i]
            camera=cam+sp
            print(camera)
            x_arr=[]
            y_arr1=[]
            y_arr2=[]
            y_arr3=[]
            y_arr4=[]

            for j in range(n_expid):
                night=night_arr[j]
                expid=expid_arr[j]
                file_preproc=preproc_dir+'/'+night+'/'+expid+'/preproc-'+camera+'-'+expid+'.fits'
                try:
                    hdul1=fits.open(file_preproc)
                except:
                    continue
                nx=len(hdul1[0].data)
                x_arr.append(hdul1[0].header['EXPTIME'])
                temp=copy.deepcopy(hdul1[0].data[x1:x2,y1:y2])
                temp=temp[np.abs(temp-np.median(temp))<5*np.std(temp)]
                y_arr1.append(np.median(temp))
                temp=copy.deepcopy(hdul1[0].data[x3:x4,y3:y4])
                temp=temp[np.abs(temp-np.median(temp))<5*np.std(temp)]
                y_arr2.append(np.median(temp))
                temp=copy.deepcopy(hdul1[0].data[x5:x6,y5:y6])
                temp=temp[np.abs(temp-np.median(temp))<5*np.std(temp)]
                y_arr3.append(np.median(temp))
                temp=copy.deepcopy(hdul1[0].data[x7:x8,y7:y8])
                temp=temp[np.abs(temp-np.median(temp))<5*np.std(temp)]
                y_arr4.append(np.median(temp))

            if x_arr:
                x_arr=np.array(x_arr)
                y_arr1=np.array(y_arr1)
                y_arr2=np.array(y_arr2)
                y_arr3=np.array(y_arr3)
                y_arr4=np.array(y_arr4)

                print(x_arr,y_arr1)
                plt.subplot(3,3,index)
                ind_fit=np.where(x_arr>150)
                plt.plot(x_arr,y_arr1,'b+',label='Region:['+str(x1)+':'+str(x2)+','+str(y1)+':'+str(y2)+']')
                plt.plot(x_arr,y_arr2,'g+',label='Region:['+str(x3)+':'+str(x4)+','+str(y3)+':'+str(y4)+']')
                plt.plot(x_arr,y_arr3,'r+',label='Region:['+str(x5)+':'+str(x6)+','+str(y5)+':'+str(y6)+']')
                plt.plot(x_arr,y_arr4,'y+',label='Region:['+str(x7)+':'+str(x8)+','+str(y7)+':'+str(y8)+']')
                #plt.axis([0,200,0,15])
                if ind_fit:
                    z1 = np.polyfit(x_arr[ind_fit], y_arr1[ind_fit], 1)
                    z2 = np.polyfit(x_arr[ind_fit], y_arr2[ind_fit], 1)
                    z3 = np.polyfit(x_arr[ind_fit], y_arr3[ind_fit], 1)
                    z4 = np.polyfit(x_arr[ind_fit], y_arr4[ind_fit], 1)

                    x=np.arange(1300)
                    plt.plot(x,z1[1]+z1[0]*x,color='blue')
                    plt.plot(x,z2[1]+z2[0]*x,color='green')
                    plt.plot(x,z3[1]+z3[0]*x,color='red')
                    plt.plot(x,z4[1]+z4[0]*x,color='yellow')
                    plt.text(500,0.3*(max(y_arr1)-min(y_arr1))+min(y_arr1),'b='+str(z1[1])[0:5])
                    plt.text(500,0.15*(max(y_arr1)-min(y_arr1))+min(y_arr1),'slope='+str(z1[0])[0:6])
                plt.xlabel('Exptime')
                plt.ylabel('Dark Current Counts')
                if index==2:
                    plt.title(camera)
                    plt.legend(loc=0)
                else:
                    plt.title(camera)
                index+=1
            #######################################

        
        plt.tight_layout()
        pdf.savefig()
        plt.close()


